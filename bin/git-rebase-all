#!/bin/bash

# Usage: ./list_tip_branches.sh [--skip-pushed] [base-branch]
SKIP_PUSHED=false
BASE_BRANCH=""

# List of possible default base branches in order
DEFAULT_BASE_BRANCHES=("develop" "origin/develop" "main" "origin/main" "master" "origin/master")

# Handle script arguments
for arg in "$@"; do
  if [ "$arg" == "--skip-pushed" ]; then
    SKIP_PUSHED=true
  else
    BASE_BRANCH="$arg"
  fi
done

# If no base branch specified, find the first existing one
if [ -z "$BASE_BRANCH" ]; then
  for candidate in "${DEFAULT_BASE_BRANCHES[@]}"; do
    if git show-ref --verify --quiet "refs/heads/$candidate" || git show-ref --verify --quiet "refs/remotes/$candidate"; then
      BASE_BRANCH="$candidate"
      break
    fi
  done
fi

if [ -z "$BASE_BRANCH" ]; then
  echo "Error: Could not find a suitable base branch." >&2
  exit 1
fi

echo "# Listing tip branches (base: $BASE_BRANCH; skip pushed: $SKIP_PUSHED)"

git branch --no-contains "$BASE_BRANCH" --sort=-committerdate | while read branch; do
  # Trim possible whitespace and "* " around the branch name
  branch=$(echo "$branch" | sed 's/^\* //' | xargs)
  if [ -z "$branch" ]; then
    continue
  fi

  # Skip remote-tracking branches
  if [[ "$branch" == "remotes/"* ]]; then
    continue
  fi

  # Skip branches that are fully pushed if the flag is enabled
  if [ "$SKIP_PUSHED" = true ]; then
    remote_status=$(git status -sb --porcelain=2 --branch "$branch" 2>/dev/null | grep "^# branch.upstream")

    if [ -n "$remote_status" ]; then
      # Check if the branch is fully synced with its upstream
      if git diff --quiet "$branch"@"{upstream}" "$branch" 2>/dev/null; then
        echo "#Â Skipping fully pushed branch: $branch"
        continue
      fi
    fi
  fi

  # Check if this is a tip branch (not contained by other branches)
  if [ "$(git branch --contains "$branch" | wc -l)" -eq 1 ]; then
    echo "git rebase '$BASE_BRANCH' '$branch' || git rebase --abort"
  fi
done
