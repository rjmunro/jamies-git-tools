#!/usr/bin/env python3
import subprocess
import re
from collections import OrderedDict

# ----------------------------
# Helper Functions
# ----------------------------
def run_git(*args):
    """Run git command and return output as string."""
    return subprocess.check_output(['git'] + list(args), text=True).strip()

def get_github_url():
    """Derive GitHub repo URL from git remote."""
    try:
        url = run_git('remote', 'get-url', 'origin')
        # Convert SSH or git URLs to https://github.com/user/repo
        if url.startswith('git@github.com:'):
            url = url[15:]
            url = url.rstrip('.git')
            return f"https://github.com/{url}"
        if url.startswith('https://github.com/'):
            url = url.rstrip('.git')
            return url
        if url.startswith('ssh://git@github.com/'):
            url = url[18:]
            url = url.rstrip('.git')
            return f"https://github.com/{url}"
        return None
    except subprocess.CalledProcessError:
        return None

def parse_tags_from_log():
    """Return OrderedDict of {commit_hash: [tags]} from git log --decorate."""
    log = run_git('log', '--first-parent', '--decorate=full', '--pretty=format:%H %d')
    commit_tags = OrderedDict()
    tag_pattern = re.compile(r'tag: ([^,)]+)')
    for line in log.splitlines():
        if not line.strip():
            continue
        parts = line.split(' ', 1)
        commit = parts[0]
        tags = tag_pattern.findall(parts[1]) if len(parts) > 1 else []
        commit_tags[commit] = tags
    return commit_tags

def get_tag_date(tag):
    try:
        return run_git('log', '-1', '--format=%Y-%m-%d', tag)
    except subprocess.CalledProcessError:
        return ''

def get_commits_between(old, new):
    """Return list of commit dicts between old..new on first-parent."""
    log_format = '%H%n%B%n---END---'
    output = run_git('log', '--first-parent', f'--pretty=format:{log_format}', f'{old}..{new}' if old else new)
    commits = []
    for raw_commit in output.split('---END---\n'):
        lines = raw_commit.strip().splitlines()
        if not lines:
            continue
        commit_hash = lines[0]
        message = '\n'.join(lines[1:]).strip()
        commits.append({'hash': commit_hash, 'message': message})
    return commits

def format_commit(message, github_url=None):
    """Return formatted changelog entry for a commit."""
    lines = message.strip().splitlines()
    pr_match = re.match(r'Merge pull request #(\d+)', lines[0]) if lines else None
    if pr_match and len(lines) > 1:
        pr_num = pr_match.group(1)
        title = lines[1].strip()
        if github_url:
            return f"* {title} ([#{pr_num}]({github_url}/pull/{pr_num}))"
        return f"* {title} (#{pr_num})"
    elif lines:
        return f"* {lines[0].strip()}"
    return None

# ----------------------------
# Main Script
# ----------------------------
def main():
    github_url = get_github_url()
    commit_tags = parse_tags_from_log()

    # Flatten commit_tags to list of (commit, tags) in newest → oldest order
    commits_with_tags = [(c, t) for c, t in commit_tags.items() if t]

    # Prepare tag sequence
    seen_tags = set()
    tag_sequence = []
    for commit, tags in commits_with_tags:
        for tag in tags:
            tag_clean = tag
            if re.match(r'^v[0-9]', tag):
                tag_clean = tag[1:]
            if tag_clean not in seen_tags:
                seen_tags.add(tag_clean)
                tag_sequence.append((tag_clean, commit))

    # Add Unreleased section
    if tag_sequence:
        first_tag_commit = tag_sequence[0][1]
        print("## Unreleased")
        unreleased_commits = get_commits_between(first_tag_commit, 'HEAD')
        for c in unreleased_commits:
            line = format_commit(c['message'], github_url)
            if line:
                print(line)
        print()

    # Generate changelog for tags newest → oldest
    for i, (tag, commit) in enumerate(tag_sequence):
        next_commit = tag_sequence[i + 1][1] if i + 1 < len(tag_sequence) else ''
        tag_date = get_tag_date(tag)
        header = f"## {tag}"
        if tag_date:
            header += f" ({tag_date})"
        print(header)
        commits = get_commits_between(next_commit, commit if commit else 'HEAD')
        for c in commits:
            line = format_commit(c['message'], github_url)
            if line:
                print(line)
        print()

if __name__ == '__main__':
    main()
